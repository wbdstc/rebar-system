<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ±æˆªé¢åˆè§„æ€§æ£€æµ‹ - é’¢ç­‹å·¥ç¨‹æ™ºèƒ½ç®¡æ§å¹³å°</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Tesseract.js OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- jsPDF & html2canvas for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            background-color: #1a1c23;
            color: #e0e0e0;
            font-family: 'Segoe UI', sans-serif;
            min-height: 100vh;
        }

        .card {
            background-color: #2c2f38;
            border: 1px solid #3a3f4b;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .card-header {
            background-color: #3a3f4b;
            color: #fff;
            border-bottom: 1px solid #48505e;
            padding: 12px 15px;
            font-weight: 600;
        }

        .form-control,
        .form-select {
            background-color: #22252b;
            border: 1px solid #444;
            color: #fff;
        }

        .form-control:focus,
        .form-select:focus {
            background-color: #2c2f38;
            color: #fff;
            border-color: #0d6efd;
            box-shadow: none;
        }

        .small-label {
            font-size: 0.8rem;
            color: #8b9bb4;
            margin-bottom: 4px;
            display: block;
        }

        .canvas-wrapper {
            position: relative;
            width: 100%;
            background: #111;
            border: 1px solid #444;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5);
            min-height: 600px;
        }

        canvas {
            display: block;
            margin: 0 auto;
        }

        .legend-box {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(18, 28, 45, 0.95);
            padding: 15px;
            border: 1px solid #0d6efd;
            border-radius: 4px;
            z-index: 100;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            color: #d0d0d0;
        }

        .dot {
            width: 10px;
            height: 10px;
            margin-right: 8px;
            border-radius: 2px;
        }

        /* éªŒæ”¶ç»“æœæ ·å¼ */
        .result-pass {
            background: linear-gradient(135deg, #1b4332, #2d6a4f);
            border: 2px solid #40c057;
            color: #a3e635;
        }

        .result-fail {
            background: linear-gradient(135deg, #5c1127, #8b1538);
            border: 2px solid #ff6b6b;
            color: #fca5a5;
        }

        .result-box {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
        }

        .result-box .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .result-box .title {
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* å¹³æ³•è¾“å…¥åŒºæ ·å¼ */
        .pingfa-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .pingfa-tag {
            display: inline-block;
            background: #3a3f4b;
            border: 1px solid #0d6efd;
            color: #00d4ff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .pingfa-tag .remove {
            cursor: pointer;
            margin-left: 5px;
            color: #ff6b6b;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stat-card {
            background: #22252b;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #00d4ff;
        }

        .stat-card .label {
            font-size: 0.8rem;
            color: #8b9bb4;
        }

        /* æŠ¥è­¦æ¨ªå¹… */
        .alert-banner {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            font-size: 1.1rem;
            font-weight: 700;
            text-align: center;
            z-index: 200;
            animation: alertPulse 1s ease-in-out infinite;
        }

        .alert-banner.danger {
            background: linear-gradient(135deg, #ff1744, #d50000);
            color: #fff;
            box-shadow: 0 4px 20px rgba(255, 23, 68, 0.5);
        }

        .alert-banner.success {
            background: linear-gradient(135deg, #00c853, #00e676);
            color: #fff;
            box-shadow: 0 4px 20px rgba(0, 200, 83, 0.5);
        }

        @keyframes alertPulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.85;
            }
        }
    </style>
</head>

<body>

    <div class="container-fluid px-4 py-4">
        <!-- é¢åŒ…å±‘å¯¼èˆª -->
        <nav class="mb-3">
            <a href="portal.html" class="text-decoration-none text-secondary"><i class="fas fa-home"></i> é¦–é¡µ</a>
            <span class="text-secondary mx-2">/</span>
            <span class="text-white">æŸ±æˆªé¢éªŒæ”¶</span>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom border-secondary">
            <div class="d-flex align-items-center gap-4">
                <div>
                    <h3 class="text-white fw-bold mb-0"><i class="fas fa-columns"></i> æŸ±æˆªé¢åˆè§„æ€§æ£€æµ‹</h3>
                    <div class="text-secondary small">Column Section Compliance Detection</div>
                </div>
            </div>
            <div>
                <a href="portal.html" class="btn btn-outline-secondary btn-sm me-2"><i class="fas fa-arrow-left"></i>
                    è¿”å›é¦–é¡µ</a>
                <button class="btn btn-outline-primary btn-sm" onclick="location.reload()"><i class="fas fa-sync"></i>
                    é‡ç½®</button>
            </div>
        </div>

        <div class="row g-4">
            <!-- å·¦ä¾§å‚æ•°åŒº -->
            <div class="col-lg-3">
                <!-- å¹³æ³•æ•°æ®å½•å…¥ -->
                <div class="card">
                    <div class="card-header"><i class="fas fa-edit"></i> å¹³æ³•æ•°æ®å½•å…¥</div>
                    <div class="card-body">
                        <label class="small-label">æŸ±å·</label>
                        <input type="text" class="form-control mb-3" id="columnId" placeholder="å¦‚ï¼šKZ1" value="KZ1">

                        <label class="small-label">æˆªé¢å°ºå¯¸ (mm)</label>
                        <div class="d-flex gap-2 mb-3">
                            <input type="number" class="form-control" id="sectionWidth" placeholder="å®½" value="650">
                            <span class="text-secondary align-self-center">Ã—</span>
                            <input type="number" class="form-control" id="sectionHeight" placeholder="é«˜" value="600">
                        </div>

                        <label class="small-label">çºµç­‹é…ç½® (å¹³æ³•æ ¼å¼)</label>
                        <div class="alert alert-dark small p-2 mb-2 text-secondary">
                            <i class="fas fa-info-circle"></i> è¾“å…¥æ ¼å¼ï¼š<code>4C22</code> è¡¨ç¤º 4 æ ¹ Ï†22 é’¢ç­‹
                        </div>
                        <div class="pingfa-input-group">
                            <input type="text" class="form-control" id="rebarInput" placeholder="å¦‚ï¼š4C22">
                            <button class="btn btn-outline-info btn-sm" onclick="addRebar()"><i
                                    class="fas fa-plus"></i></button>
                        </div>
                        <div id="rebarTags" class="mb-3">
                            <!-- åŠ¨æ€æ·»åŠ çš„æ ‡ç­¾ -->
                        </div>

                        <!-- OCR è¯†åˆ«åŒºåŸŸ -->
                        <div class="ocr-section mb-3">
                            <label class="small-label">ğŸ” OCR è‡ªåŠ¨è¯†åˆ«</label>
                            <div class="alert alert-dark small p-2 mb-2 text-secondary">
                                <i class="fas fa-magic"></i> ä¸Šä¼ å¹³æ³•æ ‡æ³¨æˆªå›¾ï¼Œè‡ªåŠ¨è¯†åˆ«å¹¶å¡«å…¥
                            </div>
                            <div class="d-flex gap-2">
                                <input type="file" id="ocrFileInput" class="form-control form-control-sm"
                                    accept="image/*" style="display:none;">
                                <button class="btn btn-outline-warning btn-sm w-100"
                                    onclick="document.getElementById('ocrFileInput').click()">
                                    <i class="fas fa-camera"></i> è¯†åˆ«æ ‡æ³¨
                                </button>
                            </div>
                            <div id="ocrStatus" class="small text-secondary mt-2" style="display:none;"></div>
                            <div id="ocrPreview" class="mt-2" style="display:none;">
                                <img id="ocrPreviewImg"
                                    style="max-width:100%; border-radius:4px; border:1px solid #444;">
                            </div>
                        </div>

                        <div class="d-flex justify-content-between small text-secondary mb-3">
                            <span>è®¾è®¡æ€»æ ¹æ•°ï¼š</span>
                            <span class="text-info fw-bold" id="designTotal">0</span>
                        </div>

                        <label class="small-label">ç®ç­‹é—´è· (mm)</label>
                        <input type="number" class="form-control mb-3" id="hoopSpacing" placeholder="å¦‚ï¼š100" value="100">
                    </div>
                </div>

                <!-- å›¾ç‰‡ä¸Šä¼ ä¸æ£€æµ‹ -->
                <div class="card">
                    <div class="card-header"><i class="fas fa-camera"></i> å›¾åƒæ£€æµ‹</div>
                    <div class="card-body">
                        <div class="alert alert-dark small p-2 mb-3 text-secondary">
                            <i class="fas fa-vector-square"></i> <b>æ“ä½œï¼š</b>ä¸Šä¼ æŸ±æˆªé¢å›¾ç‰‡åï¼Œå¯æ‹–æ‹½ç”»æ¡†æ ‡å®šå‚ç…§ç‰©ã€‚
                        </div>
                        <div class="input-group input-group-sm mb-3">
                            <span class="input-group-text bg-dark text-secondary">å‚ç…§ç‰©å®½</span>
                            <input type="number" id="refLength" class="form-control text-end text-white" value="85.6">
                            <span class="input-group-text bg-dark text-secondary">mm</span>
                        </div>

                        <input type="file" id="fileInput" class="form-control mb-3" accept="image/*">
                        <button class="btn btn-primary w-100 fw-bold py-2" onclick="startAnalysis()">
                            <i class="fas fa-bolt"></i> å¼€å§‹æ™ºèƒ½è¯†åˆ«
                        </button>
                    </div>
                </div>

                <!-- éªŒæ”¶ç»“æœ -->
                <div id="resultBox" class="result-box" style="display:none;">
                    <div class="icon"><i class="fas fa-check-circle"></i></div>
                    <div class="title">éªŒæ”¶ç»“æœ</div>
                    <div class="detail"></div>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="row g-2">
                    <div class="col-6">
                        <div class="stat-card">
                            <div class="value" id="detectedCount">-</div>
                            <div class="label">æ£€æµ‹æ•°é‡</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card">
                            <div class="value" id="avgDiameter">-</div>
                            <div class="label">å¹³å‡ç›´å¾„</div>
                        </div>
                    </div>
                </div>

                <!-- å¯¼å‡ºæŒ‰é’® -->
                <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-success flex-fill" id="exportBtn" onclick="exportToExcel()" disabled>
                        <i class="fas fa-file-excel"></i> å¯¼å‡º Excel
                    </button>
                    <button class="btn btn-danger flex-fill" id="exportPdfBtn" onclick="exportToPDF()" disabled>
                        <i class="fas fa-file-pdf"></i> å¯¼å‡º PDF
                    </button>
                </div>
            </div>

            <!-- å³ä¾§ç”»å¸ƒåŒº -->
            <div class="col-lg-9">
                <div class="canvas-wrapper">
                    <!-- æŠ¥è­¦æ¨ªå¹… -->
                    <div id="alertBanner" class="alert-banner" style="display:none;"></div>
                    <div class="legend-box" id="legendBox">
                        <div class="legend-item">
                            <div class="dot" style="background:#00e676;"></div>çºµç­‹æ£€æµ‹æ¡†
                        </div>
                        <div class="legend-item">
                            <div class="dot" style="background:#ff9800;"></div>å‚ç…§ç‰©
                        </div>
                        <div class="legend-item">
                            <div class="dot" style="background:#2196f3;"></div>å¤–ç®ç­‹
                        </div>
                        <div class="legend-item">
                            <div class="dot" style="background:#ffeb3b;"></div>å†…æ‹‰ç­‹
                        </div>
                    </div>
                    <canvas id="mainCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let imgObj = new Image();

        // --- å…¨å±€çŠ¶æ€ ---
        let appState = {
            predictions: [],
            rebarConfig: [], // [{count: 4, diameter: 22}, ...]

            // å‚ç…§ç‰©æ ‡å®š (æ‹–æ‹½ç”»æ¡†)
            refBox: null,
            isDrawing: false,
            startX: 0,
            startY: 0,
            pixelPerMm: 0
        };

        // ============================================
        // V11.0 æ ¸å¿ƒç®—æ³•ï¼šå¹³æ³•è§£æå™¨
        // ============================================

        /**
         * è§£æå¹³æ³•æ ¼å¼å­—ç¬¦ä¸²
         * æ”¯æŒæ ¼å¼ï¼š4C25, 8C22, 12C25, 4Ï†22, 4Î¦22
         * ä¹Ÿæ”¯æŒå¤åˆæ ¼å¼ï¼š"4C25 8C22" æˆ– "4C25+8C22"
         * @param {string} str - å¹³æ³•æ ¼å¼å­—ç¬¦ä¸²
         * @returns {Array<{count: number, diameter: number}>} è§£æç»“æœ
         */
        function parsePingfaString(str) {
            const results = [];
            // æ­£åˆ™åŒ¹é…æ‰€æœ‰ nCd æˆ– nÏ†d æ ¼å¼
            const regex = /(\d+)[CÎ¦Ï†](\d+)/gi;
            let match;
            while ((match = regex.exec(str)) !== null) {
                results.push({
                    count: parseInt(match[1]),
                    diameter: parseInt(match[2])
                });
            }
            return results;
        }

        /**
         * è®¡ç®—å¹³æ³•é…ç½®çš„æ€»æ ¹æ•°
         * @param {Array<{count: number, diameter: number}>} config
         * @returns {number} æ€»æ ¹æ•°
         */
        function getTotalRebarCount(config) {
            return config.reduce((sum, r) => sum + r.count, 0);
        }

        // ============================================
        // V11.0 æ ¸å¿ƒåŠŸèƒ½ï¼šOCR è‡ªåŠ¨è¯†åˆ«
        // ============================================

        // ç›‘å¬ OCR æ–‡ä»¶ä¸Šä¼ 
        document.getElementById('ocrFileInput').addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const ocrStatus = document.getElementById('ocrStatus');
            const ocrPreview = document.getElementById('ocrPreview');
            const ocrPreviewImg = document.getElementById('ocrPreviewImg');

            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function (event) {
                ocrPreviewImg.src = event.target.result;
                ocrPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // æ˜¾ç¤ºçŠ¶æ€
            ocrStatus.style.display = 'block';
            ocrStatus.innerHTML = '<i class="fas fa-spinner fa-spin text-warning"></i> æ­£åœ¨è¯†åˆ«ä¸­...';

            try {
                // è°ƒç”¨ Tesseract.js è¿›è¡Œ OCR è¯†åˆ«
                const result = await Tesseract.recognize(
                    file,
                    'chi_sim+eng', // ä¸­æ–‡ç®€ä½“ + è‹±æ–‡
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                const progress = Math.round(m.progress * 100);
                                ocrStatus.innerHTML = `<i class="fas fa-spinner fa-spin text-warning"></i> è¯†åˆ«ä¸­... ${progress}%`;
                            }
                        }
                    }
                );

                const text = result.data.text;
                console.log('OCR è¯†åˆ«ç»“æœ:', text);

                // è§£æè¯†åˆ«åˆ°çš„æ–‡å­—
                parseOcrResult(text);

                ocrStatus.innerHTML = '<i class="fas fa-check-circle text-success"></i> è¯†åˆ«å®Œæˆ';

            } catch (err) {
                console.error('OCR è¯†åˆ«å¤±è´¥:', err);
                ocrStatus.innerHTML = '<i class="fas fa-times-circle text-danger"></i> è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•';
            }
        });

        /**
         * è§£æ OCR è¯†åˆ«ç»“æœå¹¶è‡ªåŠ¨å¡«å…¥
         * @param {string} text - OCR è¯†åˆ«åˆ°çš„æ–‡å­—
         */
        function parseOcrResult(text) {
            // æå–æŸ±å· (KZ1, KZ2, GZ1 ç­‰)
            const columnMatch = text.match(/[KGZ]+Z?\d+/i);
            if (columnMatch) {
                document.getElementById('columnId').value = columnMatch[0].toUpperCase();
            }

            // æå–æˆªé¢å°ºå¯¸ (650x600, 650*600, 650Ã—600 ç­‰)
            const sectionMatch = text.match(/(\d{3,4})\s*[xÃ—\*]\s*(\d{3,4})/i);
            if (sectionMatch) {
                document.getElementById('sectionWidth').value = sectionMatch[1];
                document.getElementById('sectionHeight').value = sectionMatch[2];
            }

            // ä½¿ç”¨å¹³æ³•è§£æå™¨æå–é…ç­‹ä¿¡æ¯
            const rebarConfigs = parsePingfaString(text);

            if (rebarConfigs.length > 0) {
                // æ¸…ç©ºç°æœ‰é…ç½®ï¼Œæ·»åŠ è¯†åˆ«åˆ°çš„é…ç½®
                appState.rebarConfig = [];
                appState.rebarConfig.push(...rebarConfigs);
                renderRebarTags();
                updateDesignTotal();

                // æ˜¾ç¤ºè¯†åˆ«åˆ°çš„é…ç­‹ä¿¡æ¯
                const configStr = rebarConfigs.map(r => `${r.count}C${r.diameter}`).join(' + ');
                showAlertBanner('success', `ğŸ“· OCR è¯†åˆ«æˆåŠŸï¼é…ç­‹ï¼š${configStr}ï¼Œå…± ${getTotalRebarCount(rebarConfigs)} æ ¹`);
            } else {
                // å°è¯•æå–çº¯æ•°å­—æ ¼å¼ (å¦‚ "4 22 8 20")
                const numbers = text.match(/\d+/g);
                if (numbers && numbers.length >= 2) {
                    // å°è¯•é…å¯¹è§£æ
                    for (let i = 0; i < numbers.length - 1; i += 2) {
                        const count = parseInt(numbers[i]);
                        const diameter = parseInt(numbers[i + 1]);
                        if (count > 0 && count <= 20 && diameter >= 10 && diameter <= 40) {
                            appState.rebarConfig.push({ count, diameter });
                        }
                    }
                    if (appState.rebarConfig.length > 0) {
                        renderRebarTags();
                        updateDesignTotal();
                        showAlertBanner('success', `ğŸ“· OCR è¯†åˆ«æˆåŠŸï¼`);
                    }
                }
            }

            // å°†åŸå§‹è¯†åˆ«æ–‡æœ¬å¡«å…¥è¾“å…¥æ¡†ä¾›ç”¨æˆ·ç¡®è®¤
            if (rebarConfigs.length === 0) {
                document.getElementById('rebarInput').value = text.replace(/\n/g, ' ').trim();
            }
        }

        // --- å¹³æ³•æ•°æ®å½•å…¥ ---
        function addRebar() {
            const input = document.getElementById('rebarInput');
            const value = input.value.trim().toUpperCase();

            // ä½¿ç”¨å¹³æ³•è§£æå™¨è§£æè¾“å…¥
            const parsed = parsePingfaString(value);

            if (parsed.length === 0) {
                alert('æ ¼å¼é”™è¯¯ï¼è¯·è¾“å…¥å¦‚ 4C22 æˆ– 8C20ï¼Œä¹Ÿå¯è¾“å…¥ "4C25 8C22" ä¸€æ¬¡æ·»åŠ å¤šç»„');
                return;
            }

            // æ·»åŠ æ‰€æœ‰è§£æå‡ºçš„é…ç½®
            appState.rebarConfig.push(...parsed);
            input.value = '';
            renderRebarTags();
            updateDesignTotal();
        }

        function removeRebar(index) {
            appState.rebarConfig.splice(index, 1);
            renderRebarTags();
            updateDesignTotal();
        }

        function renderRebarTags() {
            const container = document.getElementById('rebarTags');
            container.innerHTML = appState.rebarConfig.map((r, i) =>
                `<span class="pingfa-tag">${r.count}C${r.diameter} <span class="remove" onclick="removeRebar(${i})">Ã—</span></span>`
            ).join('');
        }

        function updateDesignTotal() {
            const total = getTotalRebarCount(appState.rebarConfig);
            document.getElementById('designTotal').innerText = total;
        }

        // --- å›¾ç‰‡åŠ è½½ ---
        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (event) {
                imgObj.onload = function () {
                    appState.predictions = [];
                    appState.refBox = null;
                    appState.pixelPerMm = 0;

                    canvas.width = imgObj.width;
                    canvas.height = imgObj.height;
                    redrawCanvas();
                }
                imgObj.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        // --- é¼ æ ‡äº¤äº’ï¼šæ‹–æ‹½ç”»å‚ç…§ç‰©æ¡† ---
        canvas.addEventListener('mousedown', e => {
            if (!imgObj.src) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const mx = (e.clientX - rect.left) * scaleX;
            const my = (e.clientY - rect.top) * scaleY;

            appState.isDrawing = true;
            appState.startX = mx;
            appState.startY = my;
            appState.refBox = { x: mx, y: my, w: 0, h: 0 };
        });

        canvas.addEventListener('mousemove', e => {
            if (appState.isDrawing) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const mx = (e.clientX - rect.left) * scaleX;
                const my = (e.clientY - rect.top) * scaleY;
                appState.refBox.w = mx - appState.startX;
                appState.refBox.h = my - appState.startY;
                redrawCanvas();
            }
        });

        canvas.addEventListener('mouseup', e => {
            if (appState.isDrawing) {
                appState.isDrawing = false;
                if (Math.abs(appState.refBox.w) > 5) {
                    const pxW = Math.abs(appState.refBox.w);
                    const realW = parseFloat(document.getElementById('refLength').value);
                    appState.pixelPerMm = pxW / realW;
                    if (appState.predictions.length > 0) {
                        updateStats();
                        checkCompliance();
                    }
                }
                redrawCanvas();
            }
        });

        // --- è°ƒç”¨åç«¯ AI è¯†åˆ« ---
        async function startAnalysis() {
            if (!imgObj.src) return alert("è¯·ä¸Šä¼ å›¾ç‰‡");
            const btn = document.querySelector('button[onclick="startAnalysis()"]');
            const oldHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è°ƒç”¨ AI...';
            btn.disabled = true;

            try {
                const maxSide = 1280;
                let w = imgObj.width, h = imgObj.height;
                if (w > maxSide || h > maxSide) {
                    const r = Math.min(maxSide / w, maxSide / h);
                    w *= r;
                    h *= r;
                }
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = w;
                tempCanvas.height = h;
                tempCanvas.getContext('2d').drawImage(imgObj, 0, 0, w, h);

                tempCanvas.toBlob(async function (blob) {
                    const formData = new FormData();
                    formData.append('image', blob);

                    // å¤ç”¨ç°æœ‰ counting æ¨¡å‹
                    const url = `/analyze?mode=counting&conf=40&overlap=40`;
                    const res = await fetch(url, { method: 'POST', body: formData });
                    const data = await res.json();

                    if (data.predictions) {
                        appState.predictions = data.predictions;
                        redrawCanvas();
                        updateStats();
                        checkCompliance();
                    }
                    btn.innerHTML = oldHtml;
                    btn.disabled = false;
                }, 'image/jpeg', 0.85);
            } catch (err) {
                console.error(err);
                btn.innerHTML = oldHtml;
                btn.disabled = false;
            }
        }

        // --- ç»˜å›¾é€»è¾‘ ---
        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(imgObj, 0, 0);

            // ç»˜åˆ¶å‚ç…§ç‰©æ¡†
            if (appState.refBox && appState.refBox.w !== 0) {
                ctx.strokeStyle = "#ff9800";
                ctx.lineWidth = 3;
                ctx.setLineDash([5, 5]);
                ctx.strokeRect(appState.refBox.x, appState.refBox.y, appState.refBox.w, appState.refBox.h);
                ctx.setLineDash([]);
                ctx.fillStyle = "#ff9800";
                ctx.font = "14px Arial";
                ctx.fillText("å‚ç…§ç‰©", appState.refBox.x, appState.refBox.y - 5);
            }

            // ç»˜åˆ¶æ£€æµ‹åˆ°çš„é’¢ç­‹
            if (appState.predictions.length > 0) {
                appState.predictions.forEach((p, i) => {
                    const x = p.x - p.width / 2;
                    const y = p.y - p.height / 2;

                    // ç»˜åˆ¶æ£€æµ‹æ¡†
                    ctx.strokeStyle = "#00e676";
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, p.width, p.height);

                    // ç»˜åˆ¶ç¼–å·
                    ctx.fillStyle = "#00e676";
                    ctx.font = "bold 12px Arial";
                    ctx.fillText((i + 1).toString(), p.x - 4, p.y + 4);

                    // å¦‚æœå·²æ ‡å®šï¼Œæ˜¾ç¤ºç›´å¾„
                    if (appState.pixelPerMm > 0) {
                        const dia = (Math.min(p.width, p.height) / appState.pixelPerMm).toFixed(1);
                        ctx.fillStyle = "#fff";
                        ctx.font = "10px Arial";
                        ctx.fillText(`Ï†${dia}`, x, y - 3);
                    }
                });

                // ç»˜åˆ¶ç®ç­‹è½®å»“ (å‡¸åŒ…)
                drawHoopOutline();
            }
        }

        // ============================================
        // V11.0 æ ¸å¿ƒç®—æ³•ï¼šç®ç­‹è‡ªåŠ¨ç”Ÿæˆ
        // ============================================

        function drawHoopOutline() {
            if (appState.predictions.length < 3) return;

            // è·å–æ‰€æœ‰é’¢ç­‹ä¸­å¿ƒç‚¹
            const points = appState.predictions.map(p => ({ x: p.x, y: p.y }));

            // 1. è®¡ç®—å‡¸åŒ…ï¼ˆæœ€å¤–åœˆç‚¹ï¼‰ä½œä¸ºå¤–ç®ç­‹
            const hull = convexHull(points);
            const hullSet = new Set(hull.map(p => `${p.x},${p.y}`));

            // 2. æ‰¾å‡ºå†…éƒ¨ç‚¹ï¼ˆä¸åœ¨å‡¸åŒ…ä¸Šçš„ç‚¹ï¼‰
            const innerPoints = points.filter(p => !hullSet.has(`${p.x},${p.y}`));

            if (hull.length < 3) return;

            // === ç»˜åˆ¶å¤–ç®ç­‹ï¼ˆè“è‰²å®çº¿ï¼‰===
            ctx.strokeStyle = "#2196f3";
            ctx.lineWidth = 4;
            ctx.setLineDash([]);
            ctx.beginPath();
            ctx.moveTo(hull[0].x, hull[0].y);
            for (let i = 1; i < hull.length; i++) {
                ctx.lineTo(hull[i].x, hull[i].y);
            }
            ctx.closePath();
            ctx.stroke();

            // åœ¨å‡¸åŒ…è§’ç‚¹ç»˜åˆ¶æ ‡è®°
            hull.forEach(p => {
                ctx.fillStyle = "#2196f3";
                ctx.beginPath();
                ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
                ctx.fill();
            });

            // === ç»˜åˆ¶å†…æ‹‰ç­‹ï¼ˆé»„è‰²è™šçº¿ï¼‰===
            if (innerPoints.length > 0) {
                drawInnerTies(hull, innerPoints);
            }
        }

        /**
         * ç»˜åˆ¶å†…æ‹‰ç­‹ï¼šè¿æ¥å†…éƒ¨ç‚¹ä¸å¤–æ¡†
         * æ¨¡æ‹Ÿäº•å­—å½¢/è±å½¢ç®ç­‹çš„æ‹‰ç­‹
         */
        function drawInnerTies(hull, innerPoints) {
            ctx.strokeStyle = "#ffeb3b";
            ctx.lineWidth = 2;
            ctx.setLineDash([8, 4]);

            // è®¡ç®—å¤–æ¡†çš„è¾¹ç•Œ (æœ€å°å¤–æ¥çŸ©å½¢)
            const minX = Math.min(...hull.map(p => p.x));
            const maxX = Math.max(...hull.map(p => p.x));
            const minY = Math.min(...hull.map(p => p.y));
            const maxY = Math.max(...hull.map(p => p.y));
            const centerX = (minX + maxX) / 2;
            const centerY = (minY + maxY) / 2;

            // å°†å†…éƒ¨ç‚¹æŒ‰è¡Œåˆ—åˆ†ç»„ï¼ˆç”¨äºåˆ¤æ–­è¿æ¥æ–¹å‘ï¼‰
            const sortedByX = innerPoints.slice().sort((a, b) => a.x - b.x);
            const sortedByY = innerPoints.slice().sort((a, b) => a.y - b.y);

            // ç»˜åˆ¶æ¨ªå‘æ‹‰ç­‹
            const rows = groupByAxis(innerPoints, 'y', 30);
            rows.forEach(row => {
                if (row.length >= 1) {
                    const sortedRow = row.sort((a, b) => a.x - b.x);
                    // ä»å·¦è¾¹æ¡†åˆ°ç¬¬ä¸€ä¸ªå†…éƒ¨ç‚¹
                    ctx.beginPath();
                    ctx.moveTo(minX, sortedRow[0].y);
                    ctx.lineTo(sortedRow[0].x, sortedRow[0].y);
                    ctx.stroke();
                    // ä»æœ€åä¸€ä¸ªå†…éƒ¨ç‚¹åˆ°å³è¾¹æ¡†
                    ctx.beginPath();
                    ctx.moveTo(sortedRow[sortedRow.length - 1].x, sortedRow[sortedRow.length - 1].y);
                    ctx.lineTo(maxX, sortedRow[sortedRow.length - 1].y);
                    ctx.stroke();
                    // è¿æ¥åŒä¸€è¡Œçš„ç›¸é‚»å†…éƒ¨ç‚¹
                    for (let i = 0; i < sortedRow.length - 1; i++) {
                        ctx.beginPath();
                        ctx.moveTo(sortedRow[i].x, sortedRow[i].y);
                        ctx.lineTo(sortedRow[i + 1].x, sortedRow[i + 1].y);
                        ctx.stroke();
                    }
                }
            });

            // ç»˜åˆ¶çºµå‘æ‹‰ç­‹
            const cols = groupByAxis(innerPoints, 'x', 30);
            cols.forEach(col => {
                if (col.length >= 1) {
                    const sortedCol = col.sort((a, b) => a.y - b.y);
                    // ä»ä¸Šè¾¹æ¡†åˆ°ç¬¬ä¸€ä¸ªå†…éƒ¨ç‚¹
                    ctx.beginPath();
                    ctx.moveTo(sortedCol[0].x, minY);
                    ctx.lineTo(sortedCol[0].x, sortedCol[0].y);
                    ctx.stroke();
                    // ä»æœ€åä¸€ä¸ªå†…éƒ¨ç‚¹åˆ°ä¸‹è¾¹æ¡†
                    ctx.beginPath();
                    ctx.moveTo(sortedCol[sortedCol.length - 1].x, sortedCol[sortedCol.length - 1].y);
                    ctx.lineTo(sortedCol[sortedCol.length - 1].x, maxY);
                    ctx.stroke();
                    // è¿æ¥åŒä¸€åˆ—çš„ç›¸é‚»å†…éƒ¨ç‚¹
                    for (let i = 0; i < sortedCol.length - 1; i++) {
                        ctx.beginPath();
                        ctx.moveTo(sortedCol[i].x, sortedCol[i].y);
                        ctx.lineTo(sortedCol[i + 1].x, sortedCol[i + 1].y);
                        ctx.stroke();
                    }
                }
            });

            ctx.setLineDash([]);

            // æ ‡è®°å†…éƒ¨ç‚¹
            innerPoints.forEach(p => {
                ctx.fillStyle = "#ffeb3b";
                ctx.beginPath();
                ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        /**
         * æŒ‰åæ ‡è½´åˆ†ç»„ï¼ˆå°†æ¥è¿‘çš„ç‚¹å½’ä¸ºåŒä¸€è¡Œ/åˆ—ï¼‰
         */
        function groupByAxis(points, axis, threshold) {
            const groups = [];
            const sorted = points.slice().sort((a, b) => a[axis] - b[axis]);

            sorted.forEach(p => {
                // å°è¯•æ‰¾åˆ°å¯ä»¥åŠ å…¥çš„ç°æœ‰ç»„
                let addedToGroup = false;
                for (const group of groups) {
                    const avgAxisVal = group.reduce((sum, gp) => sum + gp[axis], 0) / group.length;
                    if (Math.abs(p[axis] - avgAxisVal) < threshold) {
                        group.push(p);
                        addedToGroup = true;
                        break;
                    }
                }
                if (!addedToGroup) {
                    groups.push([p]);
                }
            });

            return groups;
        }

        // Graham Scan å‡¸åŒ…ç®—æ³•
        function convexHull(points) {
            if (points.length < 3) return points;

            // æ‰¾åˆ°æœ€ä¸‹æ–¹çš„ç‚¹ï¼ˆyæœ€å¤§ï¼Œè‹¥ç›¸åŒå–xæœ€å°ï¼‰
            let start = points.reduce((min, p) =>
                (p.y > min.y || (p.y === min.y && p.x < min.x)) ? p : min
            );

            // æŒ‰æè§’æ’åº
            const sorted = points.slice().sort((a, b) => {
                const angleA = Math.atan2(a.y - start.y, a.x - start.x);
                const angleB = Math.atan2(b.y - start.y, b.x - start.x);
                return angleA - angleB;
            });

            // æ„å»ºå‡¸åŒ…
            const stack = [];
            for (const p of sorted) {
                while (stack.length >= 2 && cross(stack[stack.length - 2], stack[stack.length - 1], p) <= 0) {
                    stack.pop();
                }
                stack.push(p);
            }
            return stack;
        }

        function cross(o, a, b) {
            return (a.x - o.x) * (b.y - o.y) - (a.y - o.y) * (b.x - o.x);
        }

        // --- ç»Ÿè®¡æ›´æ–° ---
        function updateStats() {
            document.getElementById('detectedCount').innerText = appState.predictions.length;

            if (appState.pixelPerMm > 0 && appState.predictions.length > 0) {
                const dias = appState.predictions.map(p =>
                    Math.min(p.width, p.height) / appState.pixelPerMm
                );
                const avg = dias.reduce((a, b) => a + b, 0) / dias.length;
                document.getElementById('avgDiameter').innerText = `Ï†${avg.toFixed(1)}`;
            } else {
                document.getElementById('avgDiameter').innerText = '-';
            }
        }

        // ============================================
        // V11.0 æ ¸å¿ƒç®—æ³•ï¼šæ™ºèƒ½æŠ¥è­¦
        // ============================================

        function checkCompliance() {
            const designTotal = getTotalRebarCount(appState.rebarConfig);
            const detectedCount = appState.predictions.length;
            const columnId = document.getElementById('columnId').value || 'KZ?';

            const resultBox = document.getElementById('resultBox');
            const alertBanner = document.getElementById('alertBanner');
            resultBox.style.display = 'block';

            // éšè—æŠ¥è­¦æ¨ªå¹…
            alertBanner.style.display = 'none';

            if (designTotal === 0) {
                resultBox.className = 'result-box';
                resultBox.innerHTML = `
                    <div class="icon text-secondary"><i class="fas fa-question-circle"></i></div>
                    <div class="title text-secondary">è¯·å½•å…¥è®¾è®¡å‚æ•°</div>
                    <div class="detail">æ£€æµ‹åˆ° ${detectedCount} æ ¹é’¢ç­‹</div>
                `;
                return;
            }

            // è®¡ç®—å·®å¼‚
            const diff = detectedCount - designTotal;

            if (diff === 0) {
                // âœ… åˆæ ¼
                resultBox.className = 'result-box result-pass';
                resultBox.innerHTML = `
                    <div class="icon"><i class="fas fa-check-circle"></i></div>
                    <div class="title">âœ… éªŒæ”¶åˆæ ¼</div>
                    <div class="detail">è®¾è®¡ ${designTotal} æ ¹ | æ£€æµ‹ ${detectedCount} æ ¹</div>
                `;
                // æ˜¾ç¤ºæˆåŠŸæ¨ªå¹…
                showAlertBanner('success', `âœ… ${columnId} æŸ±éªŒæ”¶åˆæ ¼ï¼è®¾è®¡ ${designTotal} æ ¹ = æ£€æµ‹ ${detectedCount} æ ¹`);
            } else if (diff < 0) {
                // âŒ å°‘ç­‹ - ä¸¥é‡è­¦å‘Š
                resultBox.className = 'result-box result-fail';
                resultBox.innerHTML = `
                    <div class="icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="title">âŒ å°‘ç­‹è­¦å‘Š</div>
                    <div class="detail">è®¾è®¡ ${designTotal} æ ¹ | æ£€æµ‹ ${detectedCount} æ ¹ | ç¼ºå°‘ ${Math.abs(diff)} æ ¹</div>
                `;
                // æ˜¾ç¤ºå±é™©æ¨ªå¹…
                showAlertBanner('danger', `âš ï¸ è­¦å‘Šï¼š${columnId} æŸ±å°‘ç­‹ï¼è®¾è®¡è¦æ±‚ ${designTotal} æ ¹ï¼Œå®é™…æ£€æµ‹ ${detectedCount} æ ¹ï¼Œç¼ºå°‘ ${Math.abs(diff)} æ ¹ï¼`);
            } else {
                // âš ï¸ å¤šç­‹ - æç¤º
                resultBox.className = 'result-box result-pass';
                resultBox.innerHTML = `
                    <div class="icon"><i class="fas fa-info-circle"></i></div>
                    <div class="title">âš ï¸ å¤šç­‹æç¤º</div>
                    <div class="detail">è®¾è®¡ ${designTotal} æ ¹ | æ£€æµ‹ ${detectedCount} æ ¹ | å¤š ${diff} æ ¹</div>
                `;
                showAlertBanner('success', `ğŸ“Œ ${columnId} æŸ±æ£€æµ‹åˆ° ${detectedCount} æ ¹ï¼Œæ¯”è®¾è®¡å¤š ${diff} æ ¹`);
            }
        }

        /**
         * æ˜¾ç¤ºæŠ¥è­¦æ¨ªå¹…
         * @param {string} type - 'danger' æˆ– 'success'
         * @param {string} message - æ˜¾ç¤ºçš„æ¶ˆæ¯
         */
        function showAlertBanner(type, message) {
            const banner = document.getElementById('alertBanner');
            banner.className = `alert-banner ${type}`;
            banner.innerHTML = `<i class="fas fa-${type === 'danger' ? 'exclamation-circle' : 'check-circle'}"></i> ${message}`;
            banner.style.display = 'block';

            // å¯ç”¨å¯¼å‡ºæŒ‰é’®ï¼ˆæœ‰æ£€æµ‹ç»“æœæ—¶ï¼‰
            if (appState.predictions.length > 0) {
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('exportPdfBtn').disabled = false;
            }
        }

        // ============================================
        // V11.0 æ•°æ®äº¤ä»˜ï¼šExcel å¯¼å‡º
        // ============================================

        /**
         * å¯¼å‡ºç®—é‡è¡¨åˆ° Excel
         */
        function exportToExcel() {
            const columnId = document.getElementById('columnId').value || 'KZ?';
            const sectionW = document.getElementById('sectionWidth').value || '-';
            const sectionH = document.getElementById('sectionHeight').value || '-';
            const hoopSpacing = document.getElementById('hoopSpacing').value || '-';

            const designTotal = getTotalRebarCount(appState.rebarConfig);
            const detectedCount = appState.predictions.length;

            // ç”Ÿæˆé…ç­‹æè¿°å­—ç¬¦ä¸²
            const configStr = appState.rebarConfig.map(r => `${r.count}C${r.diameter}`).join(' ');

            // åˆ¤æ–­åˆè§„æ€§ç»“è®º
            let conclusion = '';
            const diff = detectedCount - designTotal;
            if (designTotal === 0) {
                conclusion = 'æœªå½•å…¥è®¾è®¡å‚æ•°';
            } else if (diff === 0) {
                conclusion = 'âœ… åˆæ ¼';
            } else if (diff < 0) {
                conclusion = `âŒ å°‘ç­‹ (ç¼º${Math.abs(diff)}æ ¹)`;
            } else {
                conclusion = `âš ï¸ å¤šç­‹ (å¤š${diff}æ ¹)`;
            }

            // è·å–å½“å‰æ—¶é—´
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            // è®¡ç®—å¹³å‡ç›´å¾„
            let avgDia = '-';
            if (appState.pixelPerMm > 0 && appState.predictions.length > 0) {
                const dias = appState.predictions.map(p =>
                    Math.min(p.width, p.height) / appState.pixelPerMm
                );
                avgDia = 'Ï†' + (dias.reduce((a, b) => a + b, 0) / dias.length).toFixed(1);
            }

            // æ„å»ºè¡¨æ ¼æ•°æ®
            const data = [
                ['æŸ±æˆªé¢åˆè§„æ€§æ£€æµ‹æŠ¥å‘Š'],
                [''],
                ['æ£€æµ‹æ—¶é—´', timeStr],
                [''],
                ['æ„ä»¶ç¼–å·', 'æˆªé¢å°ºå¯¸', 'è®¾è®¡é…ç­‹', 'è®¾è®¡æ€»æ•°', 'å®æµ‹æ€»æ•°', 'å¹³å‡ç›´å¾„', 'ç®ç­‹é—´è·', 'åˆè§„æ€§ç»“è®º'],
                [columnId, `${sectionW}Ã—${sectionH}`, configStr, designTotal, detectedCount, avgDia, `@${hoopSpacing}`, conclusion],
                [''],
                ['è¯¦ç»†é…ç­‹ä¿¡æ¯'],
                ['è§„æ ¼', 'æ•°é‡']
            ];

            // æ·»åŠ æ¯ç§è§„æ ¼çš„è¯¦ç»†ä¿¡æ¯
            appState.rebarConfig.forEach(r => {
                data.push([`Ï†${r.diameter}`, r.count]);
            });

            // æ·»åŠ å¤‡æ³¨
            data.push(['']);
            data.push(['å¤‡æ³¨ï¼šæœ¬æŠ¥å‘Šç”±é’¢ç­‹å·¥ç¨‹æ™ºèƒ½ç®¡æ§å¹³å° V11.0 è‡ªåŠ¨ç”Ÿæˆ']);

            // ä½¿ç”¨ SheetJS åˆ›å»ºå·¥ä½œç°¿
            const ws = XLSX.utils.aoa_to_sheet(data);

            // è®¾ç½®åˆ—å®½
            ws['!cols'] = [
                { wch: 12 }, // æ„ä»¶ç¼–å·
                { wch: 12 }, // æˆªé¢å°ºå¯¸
                { wch: 15 }, // è®¾è®¡é…ç­‹
                { wch: 10 }, // è®¾è®¡æ€»æ•°
                { wch: 10 }, // å®æµ‹æ€»æ•°
                { wch: 10 }, // å¹³å‡ç›´å¾„
                { wch: 10 }, // ç®ç­‹é—´è·
                { wch: 18 }  // åˆè§„æ€§ç»“è®º
            ];

            // åˆå¹¶æ ‡é¢˜å•å…ƒæ ¼
            ws['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 7 } } // åˆå¹¶ç¬¬ä¸€è¡Œæ ‡é¢˜
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'éªŒæ”¶æŠ¥å‘Š');

            // ç”Ÿæˆæ–‡ä»¶å
            const fileName = `${columnId}_éªŒæ”¶æŠ¥å‘Š_${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}.xlsx`;

            // ä¸‹è½½æ–‡ä»¶
            XLSX.writeFile(wb, fileName);

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showAlertBanner('success', `ğŸ“¥ ç®—é‡è¡¨å·²å¯¼å‡ºï¼š${fileName}`);
        }

        // ============================================
        // V11.0 æ•°æ®äº¤ä»˜ï¼šPDF æŠ¥å‘Šå¯¼å‡º
        // ============================================

        /**
         * å¯¼å‡ºæ£€æµ‹æŠ¥å‘Šåˆ° PDF
         */
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const columnId = document.getElementById('columnId').value || 'KZ?';
            const sectionW = document.getElementById('sectionWidth').value || '-';
            const sectionH = document.getElementById('sectionHeight').value || '-';
            const hoopSpacing = document.getElementById('hoopSpacing').value || '-';

            const designTotal = getTotalRebarCount(appState.rebarConfig);
            const detectedCount = appState.predictions.length;
            const configStr = appState.rebarConfig.map(r => `${r.count}C${r.diameter}`).join(' ');

            // åˆ¤æ–­åˆè§„æ€§ç»“è®º
            let conclusion = '';
            const diff = detectedCount - designTotal;
            if (designTotal === 0) {
                conclusion = 'æœªå½•å…¥è®¾è®¡å‚æ•°';
            } else if (diff === 0) {
                conclusion = 'åˆæ ¼';
            } else if (diff < 0) {
                conclusion = `å°‘ç­‹ (ç¼º${Math.abs(diff)}æ ¹)`;
            } else {
                conclusion = `å¤šç­‹ (å¤š${diff}æ ¹)`;
            }

            // è·å–å½“å‰æ—¶é—´
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showAlertBanner('success', 'ğŸ“„ æ­£åœ¨ç”Ÿæˆ PDF...');

            try {
                // åˆ›å»º PDF æ–‡æ¡£ (A4 å°ºå¯¸)
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                let y = margin;

                // æ ‡é¢˜
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.text('æŸ±æˆªé¢åˆè§„æ€§æ£€æµ‹æŠ¥å‘Š', pageWidth / 2, y, { align: 'center' });
                y += 10;

                // å‰¯æ ‡é¢˜
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.text('Column Section Compliance Detection Report', pageWidth / 2, y, { align: 'center' });
                y += 15;

                // åŸºæœ¬ä¿¡æ¯è¡¨æ ¼
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'bold');
                pdf.text('åŸºæœ¬ä¿¡æ¯', margin, y);
                y += 6;

                pdf.setFont('helvetica', 'normal');
                const info = [
                    ['æ„ä»¶ç¼–å·', columnId],
                    ['æˆªé¢å°ºå¯¸', `${sectionW} Ã— ${sectionH} mm`],
                    ['è®¾è®¡é…ç­‹', configStr],
                    ['ç®ç­‹é—´è·', `@${hoopSpacing} mm`],
                    ['æ£€æµ‹æ—¶é—´', timeStr]
                ];

                info.forEach(([label, value]) => {
                    pdf.text(`${label}ï¼š${value}`, margin, y);
                    y += 6;
                });
                y += 5;

                // æ£€æµ‹ç»“æœ
                pdf.setFont('helvetica', 'bold');
                pdf.text('æ£€æµ‹ç»“æœ', margin, y);
                y += 6;

                pdf.setFont('helvetica', 'normal');
                pdf.text(`è®¾è®¡æ€»æ ¹æ•°ï¼š${designTotal}`, margin, y);
                y += 6;
                pdf.text(`å®æµ‹æ€»æ ¹æ•°ï¼š${detectedCount}`, margin, y);
                y += 6;

                // åˆè§„æ€§ç»“è®ºå¸¦é¢œè‰²
                pdf.setFont('helvetica', 'bold');
                if (diff === 0) {
                    pdf.setTextColor(0, 150, 0);
                    pdf.text(`åˆè§„æ€§ç»“è®ºï¼šâœ“ ${conclusion}`, margin, y);
                } else if (diff < 0) {
                    pdf.setTextColor(200, 0, 0);
                    pdf.text(`åˆè§„æ€§ç»“è®ºï¼šâœ— ${conclusion}`, margin, y);
                } else {
                    pdf.setTextColor(200, 150, 0);
                    pdf.text(`åˆè§„æ€§ç»“è®ºï¼šâš  ${conclusion}`, margin, y);
                }
                pdf.setTextColor(0, 0, 0);
                y += 15;

                // æ·»åŠ æ£€æµ‹å›¾åƒ
                pdf.setFont('helvetica', 'bold');
                pdf.text('æ£€æµ‹å›¾åƒ', margin, y);
                y += 6;

                // å°† Canvas è½¬ä¸ºå›¾ç‰‡
                const canvas = document.getElementById('mainCanvas');
                const imgData = canvas.toDataURL('image/jpeg', 0.8);

                // è®¡ç®—å›¾ç‰‡å°ºå¯¸ (ä¿æŒæ¯”ä¾‹, æœ€å¤§å®½åº¦ 180mm)
                const maxImgWidth = pageWidth - 2 * margin;
                const imgRatio = canvas.height / canvas.width;
                let imgWidth = maxImgWidth;
                let imgHeight = imgWidth * imgRatio;

                // å¦‚æœå›¾ç‰‡å¤ªé«˜ï¼Œæ¢é¡µæˆ–ç¼©å°
                if (y + imgHeight > pageHeight - margin) {
                    imgHeight = pageHeight - margin - y;
                    imgWidth = imgHeight / imgRatio;
                }

                pdf.addImage(imgData, 'JPEG', margin, y, imgWidth, imgHeight);
                y += imgHeight + 10;

                // å¦‚æœéœ€è¦ï¼Œæ·»åŠ æ–°é¡µé¢
                if (y > pageHeight - 30) {
                    pdf.addPage();
                    y = margin;
                }

                // é¡µè„š
                pdf.setFontSize(8);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(128, 128, 128);
                pdf.text('æœ¬æŠ¥å‘Šç”±é’¢ç­‹å·¥ç¨‹æ™ºèƒ½ç®¡æ§å¹³å° V11.0 è‡ªåŠ¨ç”Ÿæˆ', pageWidth / 2, pageHeight - 10, { align: 'center' });

                // ç”Ÿæˆæ–‡ä»¶åå¹¶ä¸‹è½½
                const fileName = `${columnId}_éªŒæ”¶æŠ¥å‘Š_${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}.pdf`;
                pdf.save(fileName);

                showAlertBanner('success', `ğŸ“„ PDF æŠ¥å‘Šå·²å¯¼å‡ºï¼š${fileName}`);

            } catch (err) {
                console.error('PDF å¯¼å‡ºå¤±è´¥:', err);
                showAlertBanner('danger', 'âŒ PDF å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // é¡µé¢åŠ è½½æ—¶ï¼Œæ·»åŠ é»˜è®¤é…ç½®ç¤ºä¾‹
        (function init() {
            // æ·»åŠ ç¤ºä¾‹é…ç½®ï¼š4C22 + 8C20
            appState.rebarConfig = [
                { count: 4, diameter: 22 },
                { count: 8, diameter: 20 }
            ];
            renderRebarTags();
            updateDesignTotal();
        })();
    </script>
</body>

</html>